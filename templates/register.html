{% extends "base.html" %}

{% block title %}Register - Pass4Port{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <div class="flex items-center justify-center">
                <div class="bg-blue-600 p-3 rounded-lg">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
            </div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Create your Pass4Port Account
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Register to access the Visitor Management System
            </p>
        </div>
        
        <div id="registration-form" class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
            <div id="registration-alert" class="hidden rounded-md p-4 mb-4"></div>
            
            <form id="register-form" class="space-y-6">
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <div class="mt-1">
                            <input type="text" name="fullName" id="fullName" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <div class="mt-1">
                            <input type="tel" name="phone" id="phone" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <div class="mt-1">
                            <input type="email" name="email" id="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <div class="mt-1">
                            <input type="text" name="username" id="username" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <div class="mt-1">
                            <input type="password" name="password" id="password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <div class="mt-1">
                            <input type="password" name="confirmPassword" id="confirmPassword" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700">Register as</label>
                        <div class="mt-1">
                            <select id="role" name="role" required class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="visitor">Visitor</option>
                                <option value="officer">Officer</option>
                                <option value="security">Security Personnel</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>

                    <div id="aadhaar-container" class="sm:col-span-2">
                        <label for="aadhaar" class="block text-sm font-medium text-gray-700">Aadhaar Number (Required for Visitors)</label>
                        <div class="mt-1">
                            <input type="text" name="aadhaar" id="aadhaar" placeholder="12-digit Aadhaar number" class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Format: XXXX XXXX XXXX or XXXXXXXXXXXX</p>
                    </div>
                </div>

                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Photo</label>
                    <div class="webcam-container">
                        <video id="webcam" autoplay playsinline width="400" height="300" class="rounded-lg shadow-md"></video>
                        <div class="webcam-overlay"></div>
                        <button type="button" id="capture-btn" class="webcam-capture-btn px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-camera mr-2"></i> Capture Photo
                        </button>
                    </div>
                    <canvas id="canvas" width="400" height="300" class="hidden"></canvas>
                    <div id="photo-preview" class="mt-4 hidden">
                        <img id="photo" class="rounded-lg shadow-md mx-auto" alt="Captured photo">
                        <div class="mt-2 flex justify-center">
                            <button type="button" id="retake-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                <i class="fas fa-redo mr-2"></i> Retake Photo
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="photoData" id="photoData">
                </div>

                <div>
                    <button type="submit" id="register-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Register
                    </button>
                </div>
            </form>
            
            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">
                            Already have an account?
                        </span>
                    </div>
                </div>

                <div class="mt-6">
                    <a href="{{ url_for('login') }}" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign in
                    </a>
                </div>
            </div>
        </div>
        
        <div id="registration-success" class="hidden bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 text-center">
            <div class="rounded-full bg-green-100 p-3 mx-auto w-16 h-16 flex items-center justify-center">
                <i class="fas fa-check-circle text-green-600 text-3xl"></i>
            </div>
            <h3 class="mt-4 text-xl font-medium text-gray-900" id="success-title">Registration Successful!</h3>
            <p class="mt-2 text-gray-600" id="success-message">Your account has been created successfully.</p>
            <p class="mt-2 text-gray-600">Your User ID: <span id="user-id" class="font-semibold"></span></p>
            <div class="mt-6">
                <a href="{{ url_for('login') }}" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Proceed to Login
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('register-form');
    const roleSelect = document.getElementById('role');
    const aadhaarContainer = document.getElementById('aadhaar-container');
    const aadhaarInput = document.getElementById('aadhaar');
    const registrationAlert = document.getElementById('registration-alert');
    const registrationForm = document.getElementById('registration-form');
    const registrationSuccess = document.getElementById('registration-success');
    const userIdSpan = document.getElementById('user-id');
    const successTitle = document.getElementById('success-title');
    const successMessage = document.getElementById('success-message');
    
    // Webcam elements
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const photo = document.getElementById('photo');
    const captureBtn = document.getElementById('capture-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const photoPreview = document.getElementById('photo-preview');
    const photoDataInput = document.getElementById('photoData');
    
    // Initialize webcam
    let stream = null;
    
    async function initWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 400 },
                    height: { ideal: 300 },
                    facingMode: 'user'
                }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Error accessing webcam:', err);
            alert('Unable to access webcam. Please ensure you have granted camera permissions.');
        }
    }
    
    // Initialize webcam on page load
    initWebcam();
    
    // Capture photo
    captureBtn.addEventListener('click', function() {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg');
        photo.src = dataUrl;
        photoDataInput.value = dataUrl;
        
        // Show preview and hide webcam
        video.style.display = 'none';
        captureBtn.style.display = 'none';
        photoPreview.classList.remove('hidden');
    });
    
    // Retake photo
    retakeBtn.addEventListener('click', function() {
        // Show webcam and hide preview
        video.style.display = 'block';
        captureBtn.style.display = 'block';
        photoPreview.classList.add('hidden');
        photoDataInput.value = '';
    });
    
    // Show/hide Aadhaar field based on role
    roleSelect.addEventListener('change', function() {
        if (this.value === 'visitor') {
            aadhaarContainer.classList.remove('hidden');
            aadhaarInput.setAttribute('required', 'required');
        } else {
            aadhaarContainer.classList.add('hidden');
            aadhaarInput.removeAttribute('required');
        }
    });
    
    // Format Aadhaar number as user types
    aadhaarInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 12) {
            value = value.slice(0, 12);
        }
        
        // Format with spaces
        if (value.length > 8) {
            this.value = `${value.slice(0, 4)} ${value.slice(4, 8)} ${value.slice(8)}`;
        } else if (value.length > 4) {
            this.value = `${value.slice(0, 4)} ${value.slice(4)}`;
        } else {
            this.value = value;
        }
    });
    
    // Handle form submission
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            showAlert('Passwords do not match', 'error');
            return;
        }
        
        if (roleSelect.value === 'visitor' && !aadhaarInput.value) {
            showAlert('Aadhaar number is required for visitors', 'error');
            return;
        }
        
        // Disable submit button and show loading state
        const registerBtn = document.getElementById('register-btn');
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Registering...';
        
        // Prepare form data
        const formData = new FormData(this);
        
        // Remove spaces from Aadhaar number
        if (formData.get('aadhaar')) {
            formData.set('aadhaar', formData.get('aadhaar').replace(/\s/g, ''));
        }
        
        // Submit form
        fetch('/register', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                registrationForm.classList.add('hidden');
                registrationSuccess.classList.remove('hidden');
                userIdSpan.textContent = data.user_id;
                
                if (data.status === 'pending') {
                    successTitle.textContent = 'Registration Pending Approval';
                    successMessage.textContent = data.message;
                } else {
                    successTitle.textContent = 'Registration Successful!';
                    successMessage.textContent = data.message;
                }
                
                // Stop webcam stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            } else {
                // Show error message
                showAlert(data.message, 'error');
                registerBtn.disabled = false;
                registerBtn.innerHTML = 'Register';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred. Please try again.', 'error');
            registerBtn.disabled = false;
            registerBtn.innerHTML = 'Register';
        });
    });
    
    // Show alert message
    function showAlert(message, type) {
        registrationAlert.textContent = message;
        registrationAlert.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
        
        if (type === 'error') {
            registrationAlert.classList.add('bg-red-50', 'text-red-700');
        } else {
            registrationAlert.classList.add('bg-green-50', 'text-green-700');
        }
        
        // Scroll to alert
        registrationAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Clean up webcam on page unload
    window.addEventListener('beforeunload', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
});
</script>
{% endblock %}
