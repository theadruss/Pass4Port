{% extends "base.html" %}

{% block title %}Register - Pass4Port{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Create Account</h1>
            <p class="text-gray-600">Join the Pass4Port Visitor Management System</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Registration Progress</span>
                <span class="text-sm font-medium text-gray-700" id="progress-text">1/3 Steps</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progress-bar" style="width: 33%"></div>
            </div>
        </div>

        <!-- Registration Form -->
        <form id="registration-form" action="/register" method="POST" enctype="multipart/form-data" class="bg-white rounded-lg shadow-md p-6">
            
            <!-- Step 1: Basic Information -->
            <div id="step-1" class="registration-step">
                <h2 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-user mr-2 text-blue-600"></i>
                    Basic Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter your full name">
                    </div>
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter your phone number">
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="email" name="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter your email address">
                    </div>
                    
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                        <select id="role" name="role" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select your role</option>
                            <option value="visitor">Visitor</option>
                            <option value="officer">Officer</option>
                            <option value="security">Security</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                        <input type="text" id="username" name="username" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Choose a username">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                        <input type="password" id="password" name="password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Create a password">
                        <p class="text-xs text-gray-500 mt-1">Must contain at least 1 number and 1 special character</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password *</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Confirm your password">
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" id="next-step" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Next Step <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Verification -->
            <div id="step-2" class="registration-step hidden">
                <h2 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                    Identity Verification
                </h2>
                
                <!-- File Upload -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload ID Proof (Aadhaar/PAN/Passport)</label>
                    <div id="file-drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-2">Drag and drop your file here, or</p>
                        <button type="button" id="file-select-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Choose File
                        </button>
                        <input type="file" id="aadhaarFile" name="aadhaarFile" accept=".jpg,.jpeg,.png,.pdf" class="hidden">
                        <p class="text-xs text-gray-500 mt-2">Maximum file size: 5MB (JPG, PNG, PDF)</p>
                        <p id="file-name" class="text-sm text-green-600 mt-2"></p>
                    </div>
                </div>
                
                <!-- Photo Capture -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capture Your Photo</label>
                    <div class="border border-gray-300 rounded-lg p-4 text-center">
                        <video id="video" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4" autoplay></video>
                        <canvas id="canvas" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4"></canvas>
                        
                        <div class="space-x-2">
                            <button type="button" id="start-camera" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                <i class="fas fa-camera mr-2"></i>Start Camera
                            </button>
                            <button type="button" id="capture-photo" class="hidden px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-camera mr-2"></i>Capture Photo
                            </button>
                            <button type="button" id="retake-photo" class="hidden px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
                                <i class="fas fa-redo mr-2"></i>Retake Photo
                            </button>
                        </div>
                        <input type="hidden" id="photoData" name="photoData">
                    </div>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button type="button" id="prev-step" 
                            class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button type="button" id="submit-registration" disabled
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Complete Registration <i class="fas fa-check ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Success -->
            <div id="step-3" class="registration-step hidden text-center">
                <div class="mb-6">
                    <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2" id="success-message">Registration Successful!</h2>
                    <p class="text-gray-600">Your account has been created successfully.</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">User ID:</span>
                            <span id="user-id" class="text-gray-900">Loading...</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Registration Date:</span>
                            <span id="reg-date" class="text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Account Status:</span>
                            <span id="account-status" class="text-green-600 font-medium">Active</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-medium text-blue-800 mb-2">Next Steps:</h3>
                    <p id="next-steps-message" class="text-blue-700 text-sm">
                        You can now login to your account and start using the visitor management system.
                    </p>
                </div>
                
                <a href="/login" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Go to Login <i class="fas fa-sign-in-alt ml-2"></i>
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const form = document.getElementById('registration-form');
    const roleSelect = document.getElementById('role');
    let stream = null;
    
    // Initialize registration date
    document.getElementById('reg-date').textContent = new Date().toLocaleDateString();
    
    // Form navigation
    document.getElementById('next-step').addEventListener('click', function() {
        if (!validateBasicInfo()) {
            return;
        }
        
        const role = roleSelect.value;
        if (['officer', 'admin', 'security'].includes(role)) {
            // For privileged roles, skip verification and submit directly
            handlePrivilegedRegistration();
            return;
        }
        
        showStep(2);
        updateProgress(2);
    });
    
    document.getElementById('prev-step').addEventListener('click', function() {
        showStep(1);
        updateProgress(1);
    });
    
    // File upload handling
    const fileInput = document.getElementById('aadhaarFile');
    const fileSelectButton = document.getElementById('file-select-button');
    const fileDropArea = document.getElementById('file-drop-area');
    const fileName = document.getElementById('file-name');
    
    fileSelectButton.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function() {
        handleFileSelection(this);
    });
    
    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, unhighlight, false);
    });
    
    fileDropArea.addEventListener('drop', function(e) {
        handleFileDrop(e);
    });
    
    // Camera functionality
    const startCameraBtn = document.getElementById('start-camera');
    const capturePhotoBtn = document.getElementById('capture-photo');
    const retakePhotoBtn = document.getElementById('retake-photo');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photoDataInput = document.getElementById('photoData');
    
    startCameraBtn.addEventListener('click', startCamera);
    capturePhotoBtn.addEventListener('click', capturePhoto);
    retakePhotoBtn.addEventListener('click', retakePhoto);
    
    // Form submission
    document.getElementById('submit-registration').addEventListener('click', async function(e) {
        e.preventDefault();
        await submitRegistrationForm();
    });
    
    // Helper functions
    function validateBasicInfo() {
        const requiredFields = ['fullName', 'phone', 'email', 'username', 'password', 'confirmPassword', 'role'];
        let isValid = true;
        
        for (let field of requiredFields) {
            const element = document.getElementById(field);
            if (!element.value.trim()) {
                element.focus();
                alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                return false;
            }
        }
        
        // Check password match
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (password !== confirmPassword) {
            alert('Passwords do not match');
            document.getElementById('confirmPassword').focus();
            return false;
        }
        
        // Check password strength - make this more lenient for testing
        if (password.length < 6) {
            alert('Password must be at least 6 characters long');
            document.getElementById('password').focus();
            return false;
        }
        
        return true;
    }
    
    function handlePrivilegedRegistration() {
        // Submit form directly for privileged roles
        submitRegistrationForm(true);
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        fileDropArea.classList.add('border-blue-500', 'bg-blue-50');
    }
    
    function unhighlight() {
        fileDropArea.classList.remove('border-blue-500', 'bg-blue-50');
    }
    
    function handleFileSelection(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('File is too large. Maximum size is 5MB.');
                input.value = '';
                fileName.textContent = '';
                return;
            }
            fileName.textContent = file.name;
            checkFormCompletion();
        } else {
            fileName.textContent = '';
            checkFormCompletion();
        }
    }
    
    function handleFileDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files && files[0]) {
            fileInput.files = files;
            handleFileSelection(fileInput);
        }
    }
    
    function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    video.srcObject = mediaStream;
                    video.classList.remove('hidden');
                    video.play();
                    startCameraBtn.classList.add('hidden');
                    capturePhotoBtn.classList.remove('hidden');
                })
                .catch(function(err) {
                    console.error("Camera error:", err);
                    alert("Could not access camera. Proceeding without photo capture.");
                    // Enable form submission even without photo
                    checkFormCompletion();
                });
        } else {
            alert("Camera not supported. Proceeding without photo capture.");
            // Enable form submission even without photo
            checkFormCompletion();
        }
    }
    
    function capturePhoto() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        photoDataInput.value = dataURL;
        
        video.classList.add('hidden');
        canvas.classList.remove('hidden');
        capturePhotoBtn.classList.add('hidden');
        retakePhotoBtn.classList.remove('hidden');
        
        checkFormCompletion();
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }
    
    function retakePhoto() {
        canvas.classList.add('hidden');
        startCameraBtn.classList.remove('hidden');
        retakePhotoBtn.classList.add('hidden');
        photoDataInput.value = '';
        checkFormCompletion();
    }
    
    function checkFormCompletion() {
        const submitBtn = document.getElementById('submit-registration');
        // Make form completion more lenient - enable button regardless
        submitBtn.disabled = false;
    }
    
    async function submitRegistrationForm(skipVerification = false) {
        const submitBtn = document.getElementById('submit-registration');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        
        try {
            const formData = new FormData(form);
            
            // For debugging
            console.log('Submitting registration form...');
            
            const response = await fetch('/register', {
                method: 'POST',
                body: formData
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Registration failed');
                }
                
                // Show success step
                showStep(3);
                updateProgress(3);
                
                // Update UI with response data
                document.getElementById('user-id').textContent = result.user_id || 'N/A';
                document.getElementById('account-status').textContent = result.status === 'pending' ? 'Pending Approval' : 'Active';
                
                if (result.status === 'pending') {
                    document.getElementById('success-message').textContent = 'Registration Submitted for Approval';
                    document.getElementById('next-steps-message').textContent = 'Your registration requires admin approval. You will receive notification once approved.';
                    document.getElementById('account-status').textContent = 'Pending Approval';
                    document.getElementById('account-status').className = 'text-yellow-600 font-medium';
                } else {
                    document.getElementById('success-message').textContent = 'Registration Successful!';
                    document.getElementById('next-steps-message').textContent = 'You can now login to your account and start using the system.';
                }
            } else {
                // Handle non-JSON response (likely HTML redirect)
                const text = await response.text();
                if (response.ok) {
                    // If response is OK but not JSON, assume success and show step 3
                    showStep(3);
                    updateProgress(3);
                    document.getElementById('success-message').textContent = 'Registration Successful!';
                } else {
                    throw new Error('Server returned an error. Please try again.');
                }
            }
            
        } catch (error) {
            console.error('Registration error:', error);
            alert('Registration failed: ' + error.message);
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Registration <i class="fas fa-check ml-2"></i>';
        }
    }
    
    function showStep(step) {
        document.querySelectorAll('.registration-step').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${step}`).classList.remove('hidden');
        currentStep = step;
    }
    
    function updateProgress(step) {
        const progress = (step / 3) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('progress-text').textContent = `${step}/3 Steps`;
    }
});
</script>
{% endblock %}
